<!DOCTYPE html>
<html>
<head>
    <title>MSP Fleet Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: white;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .header {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .card {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .status-healthy { border-left: 4px solid #22c55e; }
        .status-warning { border-left: 4px solid #eab308; }
        .status-critical { border-left: 4px solid #ef4444; }
        .status-error { border-left: 4px solid #6b7280; }
        button {
            background: #4a90e2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #357abd; }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #888;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }
        .modal-content {
            background: #2a2a3e;
            margin: 50px auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
        }
        .modal input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #555;
            border-radius: 6px;
            background: #333;
            color: white;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1>üõ°Ô∏è MSP Fleet Dashboard</h1>
            <p>Real-time PBX Monitoring</p>
        </div>
        <div>
            <span id="lastUpdate">Last update: --:--</span>
            <button onclick="openAddModal()">+ Add PBX</button>
            <button onclick="logout()">Logout</button>
        </div>
    </div>

    <div id="fleetGrid" class="grid"></div>
    
    <div id="emptyState" class="empty-state">
        <h2>No PBX Instances</h2>
        <p>Add your first PBX to start monitoring</p>
        <button onclick="openAddModal()">Add Your First PBX</button>
    </div>

    <!-- Add PBX Modal -->
    <div id="pbxModal" class="modal">
        <div class="modal-content">
            <h3>Add PBX Instance</h3>
            <form id="pbxForm">
                <input type="text" id="pbxName" placeholder="PBX Name (e.g., Main Office)" required>
                <input type="url" id="pbxUrl" placeholder="PBX URL (https://your-pbx.yeastar.com)" required>
                <input type="text" id="appId" placeholder="App ID (Client ID)" required>
                <input type="password" id="appSecret" placeholder="App Secret (Client Secret)" required>
                <div style="margin-top: 20px;">
                    <button type="submit">Save PBX</button>
                    <button type="button" onclick="closeModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <script>
        let pbxData = [];
        let socket = null;

        // Check auth and initialize
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üîç Checking authentication...');
            
            try {
                const response = await fetch('/api/auth/check');
                const auth = await response.json();
                
                if (!auth.authenticated) {
                    console.log('‚ùå Not authenticated');
                    window.location.href = '/';
                    return;
                }
                
                console.log('‚úÖ Authenticated, initializing dashboard...');
                initializeDashboard();
                
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = '/';
            }
        });

        function initializeDashboard() {
            // Initialize Socket.io
            socket = io();
            
            socket.on('connect', () => {
                console.log('‚úÖ Socket.io connected');
            });

            socket.on('fleet-update', (data) => {
                console.log('üìä Fleet update received:', data);
                pbxData = data;
                renderFleet(data);
                updateLastUpdateTime();
            });

            // Setup form handler
            document.getElementById('pbxForm').addEventListener('submit', savePBX);
        }

        function renderFleet(data) {
            const grid = document.getElementById('fleetGrid');
            const emptyState = document.getElementById('emptyState');

            if (!data || data.length === 0) {
                grid.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            grid.style.display = 'grid';
            emptyState.style.display = 'none';

            grid.innerHTML = data.map(pbx => createHealthCard(pbx)).join('');
        }

        function createHealthCard(pbx) {
            const { health } = pbx;
            const statusClass = `status-${health.status}`;
            
            return `
                <div class="card ${statusClass}">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3>${pbx.name}</h3>
                        <span style="font-size: 12px; color: #888;">${new URL(pbx.url).hostname}</span>
                    </div>
                    
                    ${health.issues && health.issues.length > 0 ? `
                        <div style="background: rgba(239, 68, 68, 0.2); padding: 8px; border-radius: 6px; margin-bottom: 10px; font-size: 12px;">
                            ${health.issues.join('<br>')}
                        </div>
                    ` : ''}
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">
                        <div>Trunks: ${health.trunks.registered}/${health.trunks.total}</div>
                        <div>Extensions: ${health.extensions.online}/${health.extensions.total}</div>
                        <div>Calls: ${health.calls.active}/${health.calls.max}</div>
                        <div>Status: <strong>${getStatusText(health.status)}</strong></div>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <button onclick="window.open('${pbx.url}', '_blank')" style="font-size: 12px; padding: 5px 10px;">Open PBX</button>
                    </div>
                </div>
            `;
        }

        function getStatusText(status) {
            const texts = {
                healthy: 'All Systems Go',
                warning: 'Minor Issues',
                critical: 'Critical',
                error: 'Disconnected'
            };
            return texts[status] || 'Unknown';
        }

        function updateLastUpdateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('lastUpdate').textContent = `Last update: ${timeString}`;
        }

        function openAddModal() {
            document.getElementById('pbxModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('pbxModal').style.display = 'none';
            document.getElementById('pbxForm').reset();
        }

        async function savePBX(e) {
            e.preventDefault();
            
            const name = document.getElementById('pbxName').value;
            const url = document.getElementById('pbxUrl').value;
            const appId = document.getElementById('appId').value;
            const appSecret = document.getElementById('appSecret').value;

            try {
                const response = await fetch('/api/pbx', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, url, appId, appSecret })
                });

                const data = await response.json();

                if (data.success) {
                    closeModal();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Network error: ' + error.message);
            }
        }

        async function logout() {
            try {
                await fetch('/api/auth/logout', { method: 'POST' });
                window.location.href = '/';
            } catch (error) {
                console.error('Logout failed:', error);
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('pbxModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>